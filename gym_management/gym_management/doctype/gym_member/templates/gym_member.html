<!DOCTYPE html>
<html>
<head>
    <title>Gym Member Profile</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px; background: #fafafa; }
        .alert { color: red; font-weight: bold; }
        .trainer-info img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-right: 15px; vertical-align: middle; }
        .trainer-info div { display: inline-block; vertical-align: middle; }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="member-name">Loading...</h1>
    <p><b>Member ID:</b> <span id="member-id">...</span></p>

    <div class="card">
        <h3>Active/Last Plan</h3>
        <div id="active-plan">Loading...</div>
    </div>

    <div class="card">
        <h3>Allocated Trainer</h3>
        <div id="trainer-info">Loading...</div>
    </div>

    <div class="card">
        <h3>Past Plans</h3>
        <div id="past-plans">Loading...</div>
    </div>
</div>

<script>
async function loadProfile() {
    let memberIdentifier = null;

    // 1️⃣ Get member_id from URL query
    const params = new URLSearchParams(window.location.search);
    memberIdentifier = params.get("member_id"); // e.g., ?member_id=GM-01

    try {
        let memberDoc = null;

        if (memberIdentifier) {
            // Fetch by member name/id
            const memberRes = await fetch(`/api/resource/Gym Member/${memberIdentifier}`);
            if (!memberRes.ok) throw new Error("Member not found");
            memberDoc = (await memberRes.json()).data;
        } else {
            // Fetch by route
            let routePath = window.location.pathname.replace(/^\/|\/$/g, ""); // remove leading/trailing slashes
            const filters = JSON.stringify([["route", "=", routePath]]);
            const memberRes = await fetch(`/api/resource/Gym Member?filters=${encodeURIComponent(filters)}&fields=${encodeURIComponent(JSON.stringify(["name","first_name","last_name"]))}`);
            const data = (await memberRes.json()).data;
            if (!data.length) throw new Error("Member not found");
            memberDoc = data[0];

        }

        // Display member info
        document.getElementById("member-name").innerText = `${memberDoc.first_name} ${memberDoc.last_name}`;
        document.getElementById("member-id").innerText = memberDoc.name;

        // --- Fetch last plan (active or expired) ---
        const membershipFilters = JSON.stringify([["gym_member", "=", memberDoc.name]]);
        const membershipFields = JSON.stringify(["plan_name","start_date","expiry_date","status","trainer"]);
        const membershipRes = await fetch(`/api/resource/Gym Membership?filters=${encodeURIComponent(membershipFilters)}&fields=${encodeURIComponent(membershipFields)}&order_by=start_date desc`);
        const membershipData = (await membershipRes.json()).data;

        if (membershipData.length) {
            const plan = membershipData[0];
            const today = new Date();
            const end = new Date(plan.expiry_date);
            const remainingDays = Math.max(Math.ceil((end - today)/(1000*60*60*24)), 0);

            document.getElementById("active-plan").innerHTML = `
                <p><b>Plan:</b> ${plan.plan_name}</p>
                <p><b>Status:</b> ${plan.status}</p>
                <p><b>Start Date:</b> ${plan.start_date}</p>
                <p><b>Expiry Date:</b> ${plan.expiry_date}</p>
                <p><b>Remaining Days:</b> ${plan.status === 'Active' ? remainingDays : 0} ${plan.status === 'Active' && remainingDays <= 5 ? '<span class="alert">Plan expiring soon!</span>' : ''}</p>
            `;

            // --- Fetch Trainer if assigned ---
            if (plan.trainer) {
                const trainerRes = await fetch(`/api/resource/Gym Trainer/${plan.trainer}`);
                const trainerData = (await trainerRes.json()).data;
                document.getElementById("trainer-info").innerHTML = `
                    <div class="trainer-info">
                        ${trainerData.trainer_photo ? `<img src="${trainerData.trainer_photo}">` : ''}
                        <div>
                            <p><b>Name:</b> ${trainerData.trainer_name}</p>
                            <p><b>Specialization:</b> ${trainerData.specialization}</p>
                            <p><b>Experience:</b> ${trainerData.experience} years</p>
                            <p><b>Phone:</b> ${trainerData.phone_number || '-'}</p>
                            <p><b>Email:</b> ${trainerData.email || '-'}</p>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById("trainer-info").innerText = "No trainer assigned.";
            }
        } else {
            document.getElementById("active-plan").innerText = "No plans found.";
            document.getElementById("trainer-info").innerText = "No trainer assigned.";
        }

        // --- Fetch Past Plans (excluding last plan) ---
        if (membershipData.length > 1) {
            let html = '<ul>';
            membershipData.slice(1).forEach(p => {
                html += `<li>${p.plan_name} (${p.start_date} → ${p.expiry_date}) - ${p.status}</li>`;
            });
            html += '</ul>';
            document.getElementById("past-plans").innerHTML = html;
        } else {
            document.getElementById("past-plans").innerText = "No past plans.";
        }

    } catch (err) {
        console.error(err);
        document.getElementById("member-name").innerText = "Invalid Member or API error";
        document.getElementById("active-plan").innerText = "-";
        document.getElementById("trainer-info").innerText = "-";
        document.getElementById("past-plans").innerText = "-";
    }
}

loadProfile();
</script>
</body>
</html>
